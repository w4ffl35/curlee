name: CI

on:
  push:
    branches: ["master"]
  pull_request:

jobs:
  build-and-test:
    name: Build & Test (${{ matrix.preset }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        preset: [linux-debug, linux-release]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build g++ libz3-dev pkg-config clang-format ripgrep

      - name: Configure
        run: cmake --preset ${{ matrix.preset }}

      - name: Build
        run: cmake --build --preset ${{ matrix.preset }}

      - name: Test
        if: matrix.preset == 'linux-debug'
        run: |
          # Works even before you add tests (will report "0 tests")
          ctest --preset ${{ matrix.preset }} --output-on-failure

      - name: Smoke (debug)
        if: matrix.preset == 'linux-debug'
        run: bash scripts/smoke.sh --preset linux-debug --skip-build

      - name: Smoke (release)
        if: matrix.preset == 'linux-release'
        run: bash scripts/smoke.sh --preset linux-release --skip-build

  coverage-gate:
    name: Coverage Gate (linux-debug-coverage)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y cmake ninja-build g++ gcovr libz3-dev pkg-config ripgrep

      - name: Coverage
        run: |
          bash scripts/coverage.sh --fail-under 100 --fail-under-branch 100 --fail-under-function 100
